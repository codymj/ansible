---
- name: deploy mariadb
  hosts: c0p2
  vars_files:
    - ../../secrets.yml
  vars:
    ansible_python_interpreter: /usr/bin/python3
    container_name: mariadb
    mariadb_volume_path: "/volumes/mariadb"
    mariadb_user: "user"
    mariadb_database: "dev"
    backup_dir: "/backups/mariadb"
    backup_script: "/usr/local/bin/mariadb-backup.sh"
  tasks:
    - name: install python3-mysqldb
      apt:
        name: python3-mysqldb
        state: present
      become: yes
    - name: create bind mount for mariadb data
      ansible.builtin.file:
        path: "{{ mariadb_volume_path }}"
        state: directory
        owner: cmj
        group: cmj
        mode: '0755'
      become: yes
    - name: ensure correct ownership for mariadb volume
      ansible.builtin.command:
        cmd: chown -R 999:999 {{ mariadb_volume_path }}
      become: yes
    - name: pull docker image
      docker_image:
        name: mariadb
        source: pull
        tag: 10.11
    - name: start mariadb container
      docker_container:
        name: "{{ container_name }}"
        image: mariadb:10.11
        state: started
        ports:
          - "3306:3306"
        pull: true
        volumes:
         - "{{ mariadb_volume_path }}:/var/lib/mysql:rw"
        restart: true
        env:
          MARIADB_ROOT_PASSWORD: "{{ mariadb_root_password }}"
          MARIADB_USER: "{{ mariadb_user }}"
          MARIADB_PASSWORD: "{{ mariadb_password }}"
          MARIADB_DATABASE: "{{ mariadb_database }}"
    - name: pause to allow mariadb to start
      ansible.builtin.pause:
        seconds: 5
    - name: grant full privileges to the user on the database
      community.mysql.mysql_user:
        state: present
        name: "{{ mariadb_user }}"
        password: "{{ mariadb_password }}"
        login_user: root
        login_password: "{{ mariadb_root_password }}"
        login_host: "127.0.0.1"
        priv: "{{ mariadb_database }}.*:ALL"
    - name: create backup directory if it doesn't exist
      file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'
      become: yes
    - name: create the backup script
      copy:
        dest: "{{ backup_script }}"
        content: |
          #!/bin/bash
          DATE=$(date +"%Y%m%d_%H%M%S")
          BACKUP_FILE="/backup/mysql_backup_${DATE}.tar.gz"

          # standup temp container to backup mariadb data
          docker run --rm \
            --volumes-from {{ container_name }} \
            -v {{ backup_dir }}:/backup \
            alpine \
            sh -c "cd /var/lib/mysql && tar czf ${BACKUP_FILE} ."

          # keep the last 7 backups
          find {{ backup_dir }} -type f -name "*.tar.gz" -mtime +7 -delete
        mode: '0755'
      become: yes
    - name: create a cron job for daily backup
      cron:
        name: "mariadb backup (daily)"
        minute: "33"
        hour: "3"
        job: "{{ backup_script }}"
        state: present
      become: yes
